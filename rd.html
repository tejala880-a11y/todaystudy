<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
    getFirestore, collection, onSnapshot, addDoc, doc,
    updateDoc, deleteDoc, serverTimestamp, arrayUnion, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC8zXcbDNwdm2LMbpzV1KkN3wiTyh_vZ3M",
    authDomain: "o-study-f5081.firebaseapp.com",
    projectId: "o-study-f5081",
    storageBucket: "o-study-f5081.firebasestorage.app",
    messagingSenderId: "338420264881",
    appId: "1:338420264881:web:c4119859174ab264709790",
    measurementId: "G-8HCPGJ13MH"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allMembersData = [];
const memberViewStates = {};
let calendarDate = new Date();
const timersMap = {};

function getLocalDateString(date) {
    const offset = date.getTimezoneOffset();
    const adjustedDate = new Date(date.getTime() - (offset * 60 * 1000));
    return adjustedDate.toISOString().split('T')[0];
}
const TODAY_STRING = getLocalDateString(new Date());

const addMemberBtn = document.getElementById('add-member-btn');
const newMemberNameInput = document.getElementById('new-member-name');
const membersContainer = document.getElementById('members-container');
const masterCalendarContainer = document.getElementById('master-calendar-container');
const loader = document.getElementById('loader');

// üÜï Converts ms to HH:MM:SS
function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return (hours > 0 ? `${hours}:` : '') +
           `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function renderApp() {
    const tasksByDate = {};
    allMembersData.forEach(member => {
        Object.keys(member.dailyTasks || {}).forEach(date => {
            if (!tasksByDate[date]) { tasksByDate[date] = 0; }
            tasksByDate[date] += member.dailyTasks[date].length;
        });
    });

    renderMasterCalendar(calendarDate.getFullYear(), calendarDate.getMonth(), tasksByDate);
    renderMembers(allMembersData);
}

function renderMembers(members) {
    membersContainer.innerHTML = '';
    if (members.length === 0) {
        loader.style.display = 'none';
        membersContainer.innerHTML = `<p class="text-center text-slate-500 col-span-1">No members yet. Be the first to join!</p>`;
        return;
    }

    members.forEach(member => {
        const memberCard = document.createElement('div');
        memberCard.className = 'bg-white p-6 rounded-2xl shadow-lg flex flex-col';
        memberCard.setAttribute('data-id', member.id);

        const selectedDate = memberViewStates[member.id] || TODAY_STRING;
        const goalsForSelectedDate = (member.dailyTasks?.[selectedDate] || []).sort((a, b) => a.completed - b.completed);

        const totalTasks = goalsForSelectedDate.length;
        const completedTasks = goalsForSelectedDate.filter(g => g.completed).length;
        const progressPercentage = totalTasks === 0 ? 0 : (completedTasks / totalTasks) * 100;

        const goalsHtml = goalsForSelectedDate.map(goal => {
            const runningTime = goal.totalTime || 0;
            const isRunning = goal.isRunning;
            const timerDisplay = `<span class="font-mono text-sm">${formatTime(runningTime)}</span>`;
            const controls = goal.completed ? 
                `<span class="text-green-600">‚úì Done at ${goal.completedTime?.substring(11, 16) || ''}</span>` 
                : `
                <div class="flex items-center gap-2 text-sm">
                    ${timerDisplay}
                    <button class="timer-start text-green-600 hover:scale-110" title="Start">&#x25B6;</button>
                    <button class="timer-stop text-red-500 hover:scale-110" title="Stop">&#x23F8;</button>
                    <button class="timer-complete text-purple-600 hover:scale-110" title="Complete">&#x2713;</button>
                </div>
                `;

            return `
                <div class="goal-item flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 group" data-goal-id="${goal.id}" data-goal-date="${selectedDate}">
                    <label class="flex items-center cursor-pointer flex-grow">
                        <input type="checkbox" class="goal-checkbox h-5 w-5 rounded text-indigo-600" ${goal.completed ? 'checked' : ''} disabled>
                        <span class="ml-3 text-slate-700 ${goal.completed ? 'line-through text-slate-400' : ''}">${goal.text}</span>
                    </label>
                    <div class="ml-2 flex-shrink-0 text-right">
                        ${controls}
                        <button class="delete-goal-btn text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 ml-2">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>`;
        }).join('');

        memberCard.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-2xl font-bold text-indigo-700">${member.name}</h3>
                <button class="delete-member-btn text-slate-400 hover:text-red-600 text-2xl font-bold">&times;</button>
            </div>

            <div class="flex items-center gap-2 mb-4">
                <label class="font-semibold text-slate-600">Tasks for:</label>
                <input type="date" class="member-date-picker p-1 border rounded-md" value="${selectedDate}">
            </div>

            <div class="mb-4">
                <div class="flex justify-between items-center mb-1 text-sm text-slate-600">
                    <span>Progress</span>
                    <span>${completedTasks} / ${totalTasks}</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2.5">
                    <div class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
                </div>
            </div>
            
            <div class="goals-list flex-grow pr-2 overflow-y-auto" style="min-height: 150px; max-height: 300px;">${goalsHtml || `<p class="text-slate-400 p-3">No goals for ${selectedDate}.</p>`}</div>

            <div class="mt-auto pt-4 border-t flex flex-col sm:flex-row gap-2">
                <input type="text" class="new-goal-input flex-grow p-2 border rounded-lg" placeholder="Add a new goal...">
                <button class="add-goal-btn bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg">Add Goal</button>
            </div>`;
        membersContainer.appendChild(memberCard);
    });
}

function stopAllTimers(memberId) {
    if (!timersMap[memberId]) return;
    Object.values(timersMap[memberId]).forEach(ctrl => clearInterval(ctrl.intervalId));
    timersMap[memberId] = {};
}

function handleTimerEvent(e, memberId, memberDocRef) {
    const goalItem = e.target.closest('[data-goal-id]');
    if (!goalItem) return;
    const { goalId, goalDate } = goalItem.dataset;

    if (!timersMap[memberId]) timersMap[memberId] = {};

    const updateTaskField = async (updaterFn) => {
        await runTransaction(db, async (transaction) => {
            const memberSnap = await transaction.get(memberDocRef);
            if (!memberSnap.exists()) return;
            const tasks = memberSnap.data().dailyTasks || {};
            const goals = tasks[goalDate] || [];
            const updatedGoals = updaterFn(goals);
            tasks[goalDate] = updatedGoals;
            transaction.update(memberDocRef, { dailyTasks: tasks });
        });
    };

    if (e.target.classList.contains('timer-start')) {
        stopAllTimers(memberId);

        updateTaskField(goals => goals.map(g => {
            if (g.id === goalId) {
                g.isRunning = true;
                g.startTime = Date.now();
            } else {
                g.isRunning = false;
                g.startTime = null;
            }
            return g;
        }));

        // Interval for display
        const span = goalItem.querySelector('span.font-mono');
        let start = Date.now();
        const intervalId = setInterval(() => {
            const elapsed = Date.now() - start;
            span.textContent = formatTime(elapsed);
        }, 1000);

        timersMap[memberId][goalId] = { intervalId };
    }

    if (e.target.classList.contains('timer-stop')) {
        updateTaskField(goals => goals.map(g => {
            if (g.id === goalId && g.isRunning) {
                const now = Date.now();
                const duration = now - g.startTime;
                g.totalTime = (g.totalTime || 0) + duration;
                g.startTime = null;
                g.isRunning = false;
            }
            return g;
        }));
        stopAllTimers(memberId);
    }

    if (e.target.classList.contains('timer-complete')) {
        updateTaskField(goals => goals.map(g => {
            if (g.id === goalId) {
                const now = Date.now();
                if (g.isRunning) {
                    const duration = now - g.startTime;
                    g.totalTime = (g.totalTime || 0) + duration;
                }
                g.completed = true;
                g.completedTime = new Date(now).toISOString();
                g.isRunning = false;
                g.startTime = null;
            }
            return g;
        }));
        stopAllTimers(memberId);
    }
}

function handleMemberEvents(e) {
    const memberCard = e.target.closest('.bg-white[data-id]');
    if (!memberCard) return;
    const memberId = memberCard.dataset.id;
    const memberDocRef = doc(db, 'members', memberId);

    if (e.target.classList.contains('member-date-picker')) {
        memberViewStates[memberId] = e.target.value;
        renderMembers(allMembersData);
        return;
    }
    if (e.target.closest('.delete-member-btn')) {
        if (confirm('Are you sure?')) deleteDoc(memberDocRef);
        return;
    }
    if (e.target.classList.contains('add-goal-btn')) {
        const text = memberCard.querySelector('.new-goal-input').value.trim();
        const date = memberCard.querySelector('.member-date-picker').value;
        if (text && date) {
            updateDoc(memberDocRef, { [`dailyTasks.${date}`]: arrayUnion({ id: crypto.randomUUID(), text, completed: false, totalTime: 0, isRunning: false }) });
            memberCard.querySelector('.new-goal-input').value = '';
        }
        return;
    }

    handleTimerEvent(e, memberId, memberDocRef);

    if (e.target.closest('.delete-goal-btn')) {
        const { goalId, goalDate } = e.target.closest('[data-goal-id]').dataset;
        runTransaction(db, async (transaction) => {
            const docSnap = await transaction.get(memberDocRef);
            const data = docSnap.data();
            const goals = data.dailyTasks?.[goalDate] || [];
            const updated = goals.filter(g => g.id !== goalId);
            transaction.update(memberDocRef, { [`dailyTasks.${goalDate}`]: updated });
        });
    }
}

function handleCalendarEvents(e) {
    if (e.target.closest('#prev-month-btn')) {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderApp();
    }
    if (e.target.closest('#next-month-btn')) {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderApp();
    }
    const dayCell = e.target.closest('.calendar-day');
    if (dayCell) {
        const date = dayCell.dataset.date;
        allMembersData.forEach(member => { memberViewStates[member.id] = date; });
        renderMembers(allMembersData);
    }
}

function main() {
    onSnapshot(collection(db, 'members'), (snapshot) => {
        loader.style.display = 'none';
        allMembersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
            .sort((a, b) => a.name.localeCompare(b.name));
        renderApp();
    }, (error) => {
        console.error("Error loading data: ", error);
        loader.innerHTML = "Error loading data.";
    });

    addMemberBtn.addEventListener('click', () => {
        const name = newMemberNameInput.value.trim();
        if (name) {
            addDoc(collection(db, 'members'), { name, dailyTasks: {}, createdAt: serverTimestamp() });
            newMemberNameInput.value = '';
        }
    });

    masterCalendarContainer.addEventListener('click', handleCalendarEvents);
    membersContainer.addEventListener('click', handleMemberEvents);
    membersContainer.addEventListener('change', handleMemberEvents);
}

main();
</script>


