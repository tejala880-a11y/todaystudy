<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nidhi's Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Basic dark mode handling based on system preference
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        'love-pink': '#fecdd3',
                        'love-red': '#f43f5e',
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom scrollbar for a cleaner look */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .dark #messages-container::-webkit-scrollbar-track {
            background: #1e293b;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background: #fda4af;
            border-radius: 4px;
        }
        .dark #messages-container::-webkit-scrollbar-thumb {
            background: #9f1239;
        }
        #messages-container::-webkit-scrollbar-thumb:hover {
            background: #f43f5e;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-love-pink/20 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-200">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center border-b border-love-pink dark:border-gray-700 z-10">
        <h1 class="text-xl font-bold text-love-red dark:text-love-pink">Nidhi's Love Chat ❤️</h1>
        <div id="user-info" class="text-sm text-gray-500 dark:text-gray-400 hidden">
            <span class="font-mono bg-gray-200 dark:bg-gray-700 p-1 rounded">
               Your ID: <span id="user-id"></span>
            </span>
        </div>
    </header>

    <!-- Status/Error Display -->
    <div id="status-container" class="text-center p-3"></div>

    <!-- Main Content: Messages Area -->
    <main id="messages-container" class="flex-1 p-4 overflow-y-auto">
        <!-- Messages will be dynamically inserted here -->
    </main>

    <!-- Message Input Form -->
    <footer class="bg-white dark:bg-gray-800 p-4 border-t border-love-pink dark:border-gray-700">
        <form id="message-form" class="flex items-center gap-3">
            <input
                id="message-input"
                type="text"
                placeholder="Type your message with love..."
                class="flex-1 p-3 border rounded-full focus:ring-2 focus:ring-love-red focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                disabled
            />
            <button
                id="send-button"
                type="submit"
                class="bg-love-red hover:bg-rose-600 text-white font-bold py-3 px-5 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                disabled
            >
                <!-- Send Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </form>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Element References ---
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusContainer = document.getElementById('status-container');
        const userInfo = document.getElementById('user-info');
        const userIdSpan = document.getElementById('user-id');

        let db, auth, currentUser;

        // --- App ID and Firebase Config ---
        const appId = "1:338420264881:web:c4119859174ab264709790";
        // --- Firebase Configuration provided by user ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8zXcbDNwdm2LMbpzV1KkN3wiTyh_vZ3M",
            authDomain: "o-study-f5081.firebaseapp.com",
            projectId: "o-study-f5081",
            storageBucket: "o-study-f5081.appspot.com", // Corrected storage bucket domain
            messagingSenderId: "338420264881",
            appId: "1:338420264881:web:c4119859174ab264709790",
            measurementId: "G-8HCPGJ13MH"
        };


        // --- Helper function to format timestamp ---
        const formatDate = (timestamp) => {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate();
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };
        
        // --- Helper to show status/error messages ---
        const showStatus = (message, isError = false) => {
            statusContainer.textContent = message;
            statusContainer.className = isError 
                ? 'text-center text-red-500 bg-red-100 dark:bg-red-900 dark:text-red-300 p-3 rounded-lg' 
                : 'text-center text-gray-500 dark:text-gray-400';
        };

        // --- Renders a single message to the DOM ---
        const renderMessage = (msg) => {
            const isCurrentUser = msg.userId === currentUser?.uid;
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end gap-2 my-2 ${isCurrentUser ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-lg shadow ${
                isCurrentUser
                    ? 'bg-love-red text-white rounded-br-none'
                    : 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-bl-none'
            }`;

            const textP = document.createElement('p');
            textP.className = 'text-sm break-words';
            textP.textContent = msg.text;

            const timeDiv = document.createElement('div');
            timeDiv.className = `text-xs mt-1 opacity-70 ${isCurrentUser ? 'text-pink-200' : 'text-gray-500 dark:text-gray-400'}`;
            timeDiv.textContent = formatDate(msg.createdAt);
            
            messageBubble.appendChild(textP);
            messageBubble.appendChild(timeDiv);
            messageWrapper.appendChild(messageBubble);
            messagesContainer.appendChild(messageWrapper);

            // Auto-scroll to the bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        // --- Main Initialization Function ---
        const main = async () => {
            showStatus('Initializing...');

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                showStatus('Authenticating...');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        userIdSpan.textContent = currentUser.uid;
                        userInfo.classList.remove('hidden');
                        messageInput.disabled = false;
                        sendButton.disabled = false;
                        showStatus('');
                        listenForMessages();
                    } else {
                        try {
                           await signInAnonymously(auth);
                        } catch (authError) {
                            console.error("Authentication Error:", authError);
                            if (authError.code === 'auth/configuration-not-found') {
                                showStatus("Authentication failed: 'Anonymous Sign-In' is not enabled. Please enable it in your Firebase Console (Authentication > Sign-in method).", true);
                            } else {
                                showStatus("Failed to authenticate. Please check your connection or Firebase setup.", true);
                            }
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showStatus("Failed to initialize Firebase. Please check the configuration.", true);
            }
        };

        // --- Real-time Message Listener ---
        const listenForMessages = () => {
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            const q = query(collection(db, messagesCollectionPath), orderBy('createdAt'));

            onSnapshot(q, (querySnapshot) => {
                messagesContainer.innerHTML = ''; // Clear existing messages
                if (querySnapshot.empty) {
                    showStatus('No messages yet. Be the first to say hello!');
                } else {
                    showStatus('');
                }
                querySnapshot.forEach(doc => {
                    renderMessage({ id: doc.id, ...doc.data() });
                });
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                showStatus("Failed to load messages. Please try again later.", true);
            });
        };

        // --- Send Message Handler ---
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();

            if (messageText === '' || !currentUser || !db) return;

            messageInput.disabled = true;
            sendButton.disabled = true;

            try {
                const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
                await addDoc(collection(db, messagesCollectionPath), {
                    text: messageText,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                messageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showStatus("Could not send the message.", true);
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        });

        // --- Start the application ---
        main();

    </script>
</body>
</html>
