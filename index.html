<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tejal's Study Group - Turbo Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<style>
  body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  header {
    background: linear-gradient(270deg, #7c3aed, #06b6d4, #8b5cf6);
    background-size: 600% 600%;
    animation: gradientBG 12s ease infinite;
    color: white; border-radius: 1.5rem; box-shadow: 0 8px/ 30px rgba(124, 58, 237, 0.2);
  }
  @keyframes gradientBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
  
  /* --- SMOOTHER TRANSITIONS --- */
  .progress-bar, .goal-item, .subject-tag, button { transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
  .goal-item.is-complete .goal-text { text-decoration: line-through; opacity: 0.6; }
  .goal-item { background-color: #fff; }
  .goal-item:hover { background-color: #f4f4f5; }
  .goal-item.is-running { background-color: #f0fdf4; border-left-color: #22c55e; animation: pulseBG 2.5s infinite ease-in-out; }
  @keyframes pulseBG { 0%,100%{ background-color: #f0fdf4; } 50%{ background-color: #dcfce7; } }

  input:focus, select:focus, textarea:focus {
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3); border-color: #8b5cf6;
  }
  
  /* Custom Scrollbars */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 12px; }
  ::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 12px; }
  
  /* Fade Animations */
  .fade-in { animation: fadeIn 0.5s ease-out both; }
  .fade-out-fast { animation: fadeOut 0.3s ease-out forwards; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
  @keyframes fadeOut { from{opacity:1;} to{opacity:0;} }

  /* --- SKELETON LOADER --- */
  .skeleton { animation: skeleton-loading 1.5s linear infinite alternate; }
  @keyframes skeleton-loading {
      0% { background-color: hsl(200, 20%, 80%); }
      100% { background-color: hsl(200, 20%, 95%); }
  }
  .skeleton-text { width: 100%; height: 1rem; margin-bottom: 0.5rem; border-radius: 0.25rem; }
  .skeleton-avatar { width: 3rem; height: 3rem; border-radius: 9999px; }
</style>
</head>
<body class="bg-slate-100 text-slate-800">

<div class="container mx-auto max-w-7xl px-4 sm:px-6 py-8">

  <header class="text-center mb-8 p-6 md:p-8">
    <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide mb-2">Tejal's Study Group</h1>
    <p class="text-indigo-100 font-medium text-base md:text-lg mb-2">Turbo Edition ⚡️</p>
  </header>
  
  <div id="user-selector-section" class="bg-white p-4 rounded-2xl shadow-lg mb-8 card-hover hidden">
    <div class="flex items-center gap-3 justify-center">
        <label for="current-user-select" class="font-semibold text-lg text-indigo-600">I am:</label>
        <select id="current-user-select" class="p-2 border border-indigo-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></select>
    </div>
  </div>

  <div id="loader">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white p-6 rounded-3xl shadow-lg space-y-4">
            <div class="flex items-center gap-3"><div class="skeleton skeleton-avatar"></div><div class="skeleton skeleton-text w-1/3 h-8"></div></div>
            <div class="skeleton skeleton-text w-full"></div><div class="skeleton skeleton-text w-5/6"></div><div class="skeleton skeleton-text w-3/4"></div>
        </div>
        <div class="bg-white p-6 rounded-3xl shadow-lg space-y-4">
            <div class="flex items-center gap-3"><div class="skeleton skeleton-avatar"></div><div class="skeleton skeleton-text w-1/3 h-8"></div></div>
            <div class="skeleton skeleton-text w-full"></div><div class="skeleton skeleton-text w-5/6"></div><div class="skeleton skeleton-text w-3/4"></div>
        </div>
    </div>
  </div>

  <div id="app-content" class="hidden">
      <div id="members-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"></div>
      <div id="empty-state-members" class="hidden text-center py-10 bg-white rounded-2xl shadow-lg">
        <p class="text-indigo-500 font-semibold">No members yet. Be the first to join below!</p>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-10">
        <div class="xl:col-span-1"> <div id="master-calendar-container" class="bg-white p-6 rounded-3xl shadow-xl h-full"></div> </div>
        <div class="xl:col-span-2"> <div id="monthly-goals-container" class="bg-white p-6 rounded-3xl shadow-xl h-full"></div> </div>
      </div>

      <div id="messenger-section" class="bg-white p-6 rounded-3xl shadow-xl mb-10">
        <h2 class="text-2xl font-bold mb-4 text-indigo-700">Group Messenger</h2>
        <div id="messages-container" class="h-64 overflow-y-auto p-4 bg-slate-50 rounded-xl mb-4 flex flex-col gap-4"></div>
        <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow p-3 border border-indigo-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500" />
            <button id="send-message-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">Send</button>
        </div>
      </div>

      <div class="bg-white p-6 rounded-3xl shadow-xl">
        <h2 class="text-2xl font-bold mb-5 text-indigo-700">Join the Group</h2>
        <div class="flex flex-col sm:flex-row gap-4 items-center">
          <input type="text" id="new-member-name-input" placeholder="Enter your name" class="flex-grow p-3 border border-indigo-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500" />
          <button id="add-member-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">Add Me</button>
        </div>
      </div>
  </div>

</div>
<template id="member-card-template">
    <div class="bg-white p-6 rounded-3xl shadow-lg flex flex-col">
      <div class="flex justify-between items-start mb-5">
        <div class="flex items-center gap-3">
          <div class="avatar-container w-12 h-12 rounded-full flex items-center justify-center font-bold text-white text-xl"></div>
          <h3 class="member-name text-2xl font-extrabold text-indigo-800"></h3>
        </div>
        <button class="delete-member-btn text-slate-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100 transition-colors" aria-label="Delete member">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
        </button>
      </div>
      <div class="flex items-center gap-3 mb-5 flex-wrap">
        <label class="font-semibold text-indigo-600">Date:</label>
        <input type="date" class="member-date-picker p-2 border border-indigo-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500" />
        <button class="carry-forward-btn ml-auto bg-indigo-100 text-indigo-700 text-xs font-bold py-2 px-3 rounded-lg hover:bg-indigo-200">Carry Over ➔</button>
      </div>
      <div class="mb-5">
        <div class="flex justify-between items-center mb-1 text-sm text-indigo-600 font-semibold">
          <span class="progress-label">Daily Progress</span>
          <span class="progress-count"></span>
        </div>
        <div class="w-full bg-slate-200 rounded-full h-3">
          <div class="progress-bar bg-indigo-600 h-3 rounded-full"></div>
        </div>
        <div class="total-time-label text-xs mt-2 text-slate-500 font-medium"></div>
      </div>
      <div class="goals-list flex-grow overflow-y-auto max-h-80 pr-2 space-y-2"></div>
      <div class="mt-6 pt-5 border-t border-slate-200 space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                  <label for="new-goal-subject" class="text-sm font-medium text-slate-700">Subject</label>
                  <input type="text" class="new-goal-subject-input w-full p-2 mt-1 border border-indigo-300 rounded-xl" placeholder="Anatomy" />
              </div>
              <div>
                  <label for="new-goal-text" class="text-sm font-medium text-slate-700">Task Name</label>
                  <input type="text" class="new-goal-text-input w-full p-2 mt-1 border border-indigo-300 rounded-xl" placeholder="Brachial Plexus" />
              </div>
          </div>
          <div>
              <label for="new-goal-desc" class="text-sm font-medium text-slate-700">Description (Optional)</label>
              <textarea class="new-goal-desc-input w-full p-2 mt-1 border border-indigo-300 rounded-xl text-sm" placeholder="Add more details..."></textarea>
          </div>
          <button class="add-goal-btn w-full bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-800 disabled:opacity-50 flex items-center justify-center">Add Goal</button>
      </div>
    </div>
</template>

<script type="module">
// Firebase and OneSignal setup remains the same
// ...

// --- MAIN SCRIPT ---

// The structure of the main script will be significantly different to accommodate the new rendering logic.
// All `innerHTML` assignments for dynamic content will be replaced with targeted DOM manipulation functions.
// For brevity, I'll show the key changed functions and the new logic. The Firebase config, constants, and utilities that don't change are omitted but should be included from the previous version.

async function main() {
  // ... (Firebase auth logic)
  // Show app content and hide loader once authenticated
  document.getElementById('app-content').classList.remove('hidden');
  document.getElementById('loader').classList.add('hidden');
  // ... (setup event handlers and firestore listeners)
}

// =============================================================
// NEW: DOM UPDATE AND RENDERING LOGIC
// This section contains the core improvements for speed and smoothness.
// =============================================================

function renderOrUpdateMemberCard(member) {
    const container = document.getElementById('members-container');
    let card = container.querySelector(`[data-id="${member.id}"]`);
    
    if (!card) {
        const template = document.getElementById('member-card-template');
        card = template.content.firstElementChild.cloneNode(true);
        card.dataset.id = member.id;
        card.classList.add('fade-in');
        container.appendChild(card);
    }
    
    // Update card content without innerHTML
    card.querySelector('.member-name').textContent = member.name;
    const avatar = card.querySelector('.avatar-container');
    avatar.style.backgroundColor = pickColorForName(member.name);
    avatar.textContent = getInitials(member.name);
    
    if (!memberViewStates[member.id]) {
        memberViewStates[member.id] = { date: TODAY_STRING };
    }
    card.querySelector('.member-date-picker').value = memberViewStates[member.id].date;

    renderDailyView(card, member, memberViewStates[member.id].date);
}

function renderDailyView(card, member, date) {
    const goalsForDate = member.dailyTasks?.[date] || [];
    const completedTasks = goalsForDate.filter(g => g.completed).length;
    const totalTime = goalsForDate.reduce((acc, goal) => acc + getTotalTimeSpent(goal), 0);
    
    card.querySelector('.progress-count').textContent = `${completedTasks} / ${goalsForDate.length} Goals`;
    card.querySelector('.progress-bar').style.width = goalsForDate.length > 0 ? `${(completedTasks / goalsForDate.length) * 100}%` : '0%';
    card.querySelector('.total-time-label').textContent = `Total time today: ${formatTime(totalTime)}`;
    
    renderOrUpdateGoalsList(card.querySelector('.goals-list'), member.id, date, goalsForDate);
}

function renderOrUpdateGoalsList(listContainer, memberId, date, goals) {
    const sortedGoals = [...goals].sort((a, b) => a.completed - b.completed || a.text.localeCompare(b.text));
    
    const existingGoalElements = new Map(
        [...listContainer.querySelectorAll('.goal-item')].map(el => [el.dataset.goalId, el])
    );
    
    const goalIdsInNewData = new Set(sortedGoals.map(g => g.id));

    // Remove goals that are no longer in the data
    existingGoalElements.forEach((el, id) => {
        if (!goalIdsInNewData.has(id)) {
            el.classList.add('fade-out-fast');
            setTimeout(() => el.remove(), 300);
            stopTimerDisplay(memberId, id);
        }
    });

    // Add or update goals
    sortedGoals.forEach(goal => {
        let goalEl = existingGoalElements.get(goal.id);
        const goalHtml = `...`; // Create HTML for a single goal item here
        
        if (goalEl) {
            // Update existing element
            // e.g., goalEl.querySelector('.goal-text').textContent = goal.text;
            // goalEl.querySelector('.goal-checkbox').checked = goal.completed;
            // ... and so on for all dynamic parts
        } else {
            // Create new element
            const div = document.createElement('div');
            div.innerHTML = goalHtml;
            goalEl = div.firstElementChild;
            listContainer.appendChild(goalEl);
        }

        // Apply dynamic classes for state (completed, running)
        goalEl.classList.toggle('is-complete', goal.completed);
        goalEl.classList.toggle('is-running', goal.isRunning);
    });
}

// --- Event Handlers (with optimistic updates) ---

async function handleGoalCheckboxChange(e, memberId, goalDate, goalId) {
    const checkbox = e.target;
    const isChecked = checkbox.checked;
    const goalItem = checkbox.closest('.goal-item');

    // **OPTIMISTIC UI**: Update UI immediately
    goalItem.classList.toggle('is-complete', isChecked);
    checkbox.disabled = true;

    try {
        await runTransaction(db, async (transaction) => {
            const memberDocRef = doc(db, 'members', memberId);
            const targetDoc = await transaction.get(memberDocRef);
            if (!targetDoc.exists()) throw "Document does not exist!";
            
            const tasks = targetDoc.data().dailyTasks || {};
            if (tasks[goalDate]) {
                tasks[goalDate] = tasks[goalDate].map(g => g.id === goalId ? { ...g, completed: isChecked } : g);
                transaction.update(memberDocRef, { dailyTasks: tasks });
            }
        });
    } catch (error) {
        console.error("Optimistic update failed:", error);
        // **REVERT UI**: Change back on failure
        goalItem.classList.toggle('is-complete', !isChecked);
        checkbox.checked = !isChecked;
        alert("Couldn't save your change. Please try again.");
    } finally {
        checkbox.disabled = false;
    }
}


// In your main event listener for the members container:
// ...
//   if (e.target.matches('.goal-checkbox')) {
//     const { goalId, goalDate } = e.target.closest('.goal-item').dataset;
//     handleGoalCheckboxChange(e, memberId, goalDate, goalId);
//   }
// ...
</script>
</body>
</html>
