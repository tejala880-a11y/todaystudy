<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tejal's Study Group - Upgraded Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<style>
  body { font-family: 'Inter', sans-serif; }
  header {
    background: linear-gradient(270deg, #7c3aed, #06b6d4, #8b5cf6);
    background-size: 600% 600%;
    animation: gradientBG 12s ease infinite;
    color: white; border-radius: 1.5rem; box-shadow: 0 8px 30px rgba(124, 58, 237, 0.2);
  }
  @keyframes gradientBG {
    0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
  }
  .card-hover, button, input, select {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .card-hover:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(124, 58, 237, 0.15);
  }
  button:hover {
    transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  input:focus, select:focus {
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3); border-color: #8b5cf6;
  }
  .goals-list::-webkit-scrollbar, .messages-container::-webkit-scrollbar, .monthly-goals-list::-webkit-scrollbar { width: 8px; }
  .goals-list::-webkit-scrollbar-track, .messages-container::-webkit-scrollbar-track, .monthly-goals-list::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 12px; }
  .goals-list::-webkit-scrollbar-thumb, .messages-container::-webkit-scrollbar-thumb, .monthly-goals-list::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 12px; }
  .goal-item:hover .delete-goal-btn, .goal-item:hover .copy-to-daily-btn { opacity: 1; transform: scale(1); }
  .calendar-day.has-tasks { background-color: #e0e7ff; font-weight: 600; }
  .calendar-day.is-today { box-shadow: 0 0 0 2px #7c3aed; border-radius: 0.5rem; }
  .timer-running { animation: pulse 2.5s infinite ease-in-out; }
  .timer-display { font-family: 'Courier New', monospace; font-weight: 700; letter-spacing: 0.5px; }
  @keyframes pulse { 0%,100%{ opacity:1; } 50%{ opacity:0.6; } }
  .play-btn, .stop-btn { width: 34px; height: 34px; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
  .play-btn { background-color: #10b981; color: white; }
  .stop-btn { background-color: #ef4444; color: white; }
  .delete-goal-btn, .copy-to-daily-btn { opacity: 0; transform: scale(0.8); transition: all 0.3s ease; }
  .message { background-color: #f1f5f9; padding: 0.75rem 1rem; border-radius: 1.25rem; max-width: 85%; }
  .message.sent { background-color: #e0e7ff; align-self: flex-end; border-bottom-right-radius: 0.5rem; }
  .message.received { border-bottom-left-radius: 0.5rem; }
  .link-bubble { color:#0f172a; text-decoration:underline; font-weight: 500; }
  .fade-in { animation: fadeIn 0.5s ease-out both; }
  .fade-out { animation: fadeOut 0.4s ease-out forwards; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }
  @keyframes fadeOut { from{opacity:1; transform: scale(1);} to{opacity:0; transform: scale(0.95);} }
</style>
</head>
<body class="bg-slate-100 text-slate-800">

<div class="container mx-auto max-w-5xl px-6 py-8">

  <header class="text-center mb-8 p-6 md:p-8">
    <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide mb-2">Tejal's Study Group</h1>
    <p class="text-indigo-100 font-medium text-base md:text-lg mb-2">Upgraded for Maximum Productivity ðŸš€</p>
    <div class="text-sm text-indigo-200">Daily & Monthly Goals, Timers, and Messenger.</div>
  </header>

  <div id="members-container" class="grid grid-cols-1 gap-8 mb-8"></div>
  <div id="loader" class="text-center py-10 text-slate-500">Authenticating...</div>
  <div id="empty-state-members" class="hidden text-center py-10 bg-white rounded-2xl shadow-lg">
    <p class="text-indigo-500 font-semibold">No members yet. Be the first to join below!</p>
  </div>

  <div id="master-calendar-container" class="bg-white p-6 rounded-3xl shadow-xl mb-6 card-hover"></div>

  <div id="messenger-section" class="bg-white p-6 rounded-3xl shadow-xl mb-10 card-hover">
    <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Group Messenger</h2>
    <div class="flex items-center gap-3 mb-4 flex-wrap">
        <label for="messenger-user-select" class="font-semibold text-indigo-600">I am:</label>
        <select id="messenger-user-select" class="p-2 border border-indigo-300 rounded-lg">
            <option value="">-- Select your name --</option>
        </select>
    </div>
    <div id="messages-container" class="messages-container h-64 overflow-y-auto p-4 bg-slate-50 rounded-xl mb-4 flex flex-col gap-4"></div>
    <div class="flex flex-col sm:flex-row gap-3">
        <input type="text" id="message-input" placeholder="Type a message or paste a link..." class="flex-grow p-3 border border-indigo-300 rounded-xl focus:ring-0 focus:outline-none" />
        <button id="send-message-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 shadow-md">Send</button>
    </div>
  </div>

  <div id="monthly-goals-container" class="bg-white p-6 rounded-3xl shadow-xl mb-10 card-hover"></div>

  <div class="bg-white p-6 rounded-3xl shadow-xl card-hover">
    <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Add a New Member</h2>
    <div class="flex flex-col sm:flex-row gap-4 items-center">
      <input type="text" id="new-member-name-input" placeholder="Enter your name" class="flex-grow p-3 border border-indigo-300 rounded-xl focus:ring-0 focus:outline-none" />
      <button id="add-member-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 shadow-md">Add Me</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, arrayUnion, runTransaction, query, orderBy, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// --- Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyC8zXcbDNwdm2LMbpzV1KkN3wiTyh_vZ3M",
    authDomain: "o-study-f5081.firebaseapp.com",
    projectId: "o-study-f5081",
    storageBucket: "o-study-f5081.appspot.com",
    messagingSenderId: "338420264881",
    appId: "1:338420264881:web:c4119859174ab264709790"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- OneSignal Initialization ---
window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
    OneSignal.init({
        appId: "3908e089-73c0-40d4-9f2c-733204a82a01",
        safari_web_id: "web.onesignal.auto.123456-7890ab-cdef-1234",
        allowLocalhostAsSecureOrigin: true,
    });
});

// --- State Management ---
let allMembersData = [];
const memberViewStates = {};
let calendarDate = new Date();
const timerIntervals = {};
let currentMessengerId = localStorage.getItem('currentMessengerId') || '';

// --- Utility Functions ---
const getLocalDateString = (date) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
const getYearMonthString = (date) => date.toISOString().slice(0, 7);
const TODAY_STRING = getLocalDateString(new Date());

const formatTime = (ms) => {
    const totalSeconds = Math.floor(ms / 1000);
    const m = Math.floor(totalSeconds / 60);
    const s = totalSeconds % 60;
    return `${m}:${s.toString().padStart(2, '0')}`;
}

const getTotalTimeSpent = (goal) => (goal.totalTime || 0) + (goal.isRunning && goal.startTime ? Date.now() - goal.startTime : 0);
const getInitials = (name) => (name || 'U').split(' ').map(s => s[0]).slice(0, 2).join('').toUpperCase();
const pickColorForName = (name) => {
    const colors = ['#7c3aed', '#06b6d4', '#ef4444', '#f59e0b', '#0ea5a4', '#a78bfa', '#10b981'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = (hash << 5) - hash + name.charCodeAt(i);
    return colors[Math.abs(hash) % colors.length];
};

// --- Push Notification Functions ---
function identifyUserInOneSignal(yourInternalUserId) {
    if (!yourInternalUserId || !window.OneSignal) return;
    window.OneSignal.push(() => {
        OneSignal.setExternalUserId(yourInternalUserId);
    });
}

// --- DOM Rendering ---
function renderApp() {
    const tasksByDate = {};
    allMembersData.forEach(member => {
        Object.entries(member.dailyTasks || {}).forEach(([date, tasks]) => {
            tasksByDate[date] = (tasksByDate[date] || 0) + tasks.length;
        });
    });
    renderMasterCalendar(calendarDate.getFullYear(), calendarDate.getMonth(), tasksByDate);
    updateMembersUI(allMembersData);
    renderSharedMonthlyView();
    updateMessengerUserSelect();
}

function renderMasterCalendar(year, month, tasksByDate) {
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const calendarHtml = `
    <div class="flex items-center justify-between mb-4 px-2">
      <button id="prev-month-btn" class="p-2 rounded-full hover:bg-indigo-100">&lt;</button>
      <h2 class="text-xl font-bold text-indigo-700">${monthNames[month]} ${year}</h2>
      <button id="next-month-btn" class="p-2 rounded-full hover:bg-indigo-100">&gt;</button>
    </div>
    <div class="grid grid-cols-7 gap-2 text-center text-sm font-semibold text-indigo-500 px-2">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div class="grid grid-cols-7 gap-1 mt-2 px-2">${
        Array(firstDay).fill('<div></div>').join('') +
        Array.from({length: daysInMonth}, (_, i) => {
            const day = i + 1;
            const dateStr = getLocalDateString(new Date(year, month, day));
            return `<div class="calendar-day cursor-pointer p-2 text-center rounded-lg 
                ${tasksByDate[dateStr] > 0 ? 'has-tasks' : ''} 
                ${dateStr === TODAY_STRING ? 'is-today' : ''} hover:bg-indigo-200" data-date="${dateStr}">${day}</div>`;
        }).join('')
    }</div>`;
    document.getElementById('master-calendar-container').innerHTML = calendarHtml;
}

function updateMembersUI(members) {
    const container = document.getElementById('members-container');
    document.getElementById('loader').style.display = 'none';
    document.getElementById('empty-state-members').style.display = members.length === 0 ? 'block' : 'none';

    const memberIds = new Set(members.map(m => m.id));
    
    Array.from(container.children).forEach(child => {
        if (!memberIds.has(child.dataset.id)) {
            child.classList.add('fade-out');
            setTimeout(() => child.remove(), 400);
        }
    });

    members.forEach((member, index) => {
        let memberCard = container.querySelector(`[data-id="${member.id}"]`);
        if (!memberCard) {
            memberCard = createMemberCard(member);
            memberCard.style.animationDelay = `${index * 100}ms`;
            container.appendChild(memberCard);
        }
        updateMemberCard(memberCard, member);
    });
}

function createMemberCard(member) {
    const card = document.createElement('div');
    card.className = 'bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-3xl shadow-lg flex flex-col fade-in';
    card.dataset.id = member.id;
    card.innerHTML = `
      <div class="flex justify-between items-start mb-5">
        <div class="flex items-center gap-3">
          <div class="avatar-container w-12 h-12 rounded-full flex items-center justify-center font-bold text-white text-xl" style="background-color:${member.avatarColor}">${getInitials(member.name)}</div>
          <h3 class="text-2xl font-extrabold text-indigo-800">${member.name}</h3>
        </div>
        <button class="delete-member-btn text-indigo-400 hover:text-red-600 p-1" aria-label="Delete member">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
        </button>
      </div>
      
      <div class="flex items-center gap-3 mb-5 flex-wrap">
        <label class="font-semibold text-indigo-600">Date:</label>
        <input type="date" class="member-date-picker p-2 border border-indigo-300 rounded-lg bg-white" />
        <button class="carry-forward-btn ml-auto bg-indigo-100 text-indigo-700 text-xs font-bold py-2 px-3 rounded-lg hover:bg-indigo-200">Carry Over âž”</button>
      </div>
      <div class="mb-5">
        <div class="flex justify-between items-center mb-1 text-sm text-indigo-600 font-semibold"><span>Daily Progress</span><span class="progress-count"></span></div>
        <div class="w-full bg-indigo-200 rounded-full h-3"><div class="progress-bar bg-indigo-600 h-3 rounded-full" style="width:0%;"></div></div>
        <div class="total-time-label text-xs mt-2 text-indigo-500 font-medium"></div>
      </div>
      <div class="goals-list flex-grow overflow-y-auto max-h-80 pr-2"></div>
      <div class="mt-6 pt-5 border-t flex flex-col sm:flex-row gap-3">
        <input type="text" class="new-goal-input flex-grow p-3 border border-indigo-300 rounded-xl" placeholder="Add a new daily goal..." />
        <button class="add-goal-btn bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-800">Add Goal</button>
      </div>
      `;
    return card;
}

function updateMemberCard(card, member) {
    if (!memberViewStates[member.id]) {
        memberViewStates[member.id] = { date: TODAY_STRING };
    }
    const state = memberViewStates[member.id];
    renderDailyView(card, member, state.date);
}

function renderDailyView(card, member, date) {
    card.querySelector('.member-date-picker').value = date;
    const goalsForDate = member.dailyTasks?.[date] || [];
    const completedTasks = goalsForDate.filter(g => g.completed).length;
    const totalTime = goalsForDate.reduce((acc, goal) => acc + getTotalTimeSpent(goal), 0);
    
    card.querySelector('.progress-count').textContent = `${completedTasks} / ${goalsForDate.length} Goals`;
    card.querySelector('.progress-bar').style.width = goalsForDate.length > 0 ? `${(completedTasks / goalsForDate.length) * 100}%` : '0%';
    card.querySelector('.total-time-label').textContent = `Total time today: ${formatTime(totalTime)}`;
    
    renderGoalsForMember(card.querySelector('.goals-list'), member.id, date, goalsForDate);
}

function renderSharedMonthlyView() {
    const container = document.getElementById('monthly-goals-container');
    if (allMembersData.length === 0) {
        container.innerHTML = ''; // Hide if no members
        return;
    }

    const monthStr = getYearMonthString(calendarDate);
    const firstMember = allMembersData[0]; // Tasks are the same for everyone, so we use one as a reference
    const monthlyTasks = firstMember.monthlyTasks?.[monthStr] || [];

    const myCompletedTasks = monthlyTasks.filter(task => task.completedBy?.[currentMessengerId]).length;
    
    let html = `
        <h2 class="text-2xl font-semibold mb-5 text-purple-700">Group Monthly Goals (${new Date(monthStr).toLocaleString('default', { month: 'long', timeZone: 'UTC' })})</h2>
    `;

    if (currentMessengerId) { // Show personal progress bar only if a user is selected
        html += `
          <div class="mb-5">
            <div class="flex justify-between items-center mb-1 text-sm text-purple-600 font-semibold"><span>Your Progress</span><span class="monthly-progress-count">${myCompletedTasks} / ${monthlyTasks.length} Goals</span></div>
            <div class="w-full bg-purple-200 rounded-full h-3"><div class="monthly-progress-bar bg-purple-600 h-3 rounded-full" style="width:${monthlyTasks.length > 0 ? (myCompletedTasks / monthlyTasks.length) * 100 : 0}%;"></div></div>
          </div>
        `;
    }

    if (monthlyTasks.length === 0) {
        html += '<p class="text-purple-400 p-4 text-center">No monthly goals set for this month.</p>';
    } else {
        html += `<div class="monthly-goals-list flex-grow overflow-y-auto max-h-96 pr-2">` + 
        monthlyTasks.map(task => `
            <div class="goal-item p-3 rounded-xl hover:bg-purple-100 group" data-task-id="${task.id}">
                <div class="flex justify-between items-center">
                    <p class="font-semibold text-purple-800">${task.text}</p>
                    <div class="flex items-center gap-2">
                        <button class="copy-to-daily-btn text-purple-400 hover:text-purple-600" title="Copy to my Daily Tasks">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 8a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1h-15A.5.5 0 0 1-1 8z"/></svg>
                        </button>
                        <button class="delete-goal-btn text-purple-400 hover:text-red-500" title="Delete Monthly Goal">X</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 gap-2 mt-3 text-sm">
                    ${allMembersData.map(m => `
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="monthly-goal-checkbox h-4 w-4 rounded text-purple-600" 
                                   data-member-id="${m.id}" ${task.completedBy?.[m.id] ? 'checked' : ''}>
                            <span class="text-slate-700">${m.name.split(' ')[0]}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('') + `</div>`;
    }

    html += `
        <div class="mt-6 pt-5 border-t flex flex-col sm:flex-row gap-3">
          <input type="text" id="new-monthly-goal-input" class="flex-grow p-3 border border-purple-300 rounded-xl" placeholder="Add new group monthly goal..." />
          <button id="add-monthly-goal-btn" class="bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl hover:bg-purple-800">Add Goal</button>
        </div>
    `;
    container.innerHTML = html;
}

function renderGoalsForMember(listContainer, memberId, date, goals) {
    if (goals.length === 0) {
        listContainer.innerHTML = '<p class="text-indigo-400 p-4 text-center">No goals for this day. Add one below!</p>';
        return;
    }

    const sortedGoals = [...goals].sort((a, b) => a.completed - b.completed);
    listContainer.innerHTML = sortedGoals.map(goal => `
        <div class="goal-item flex items-center justify-between p-3 rounded-xl hover:bg-indigo-100 group ${goal.isRunning ? 'timer-running bg-green-50' : ''}" data-goal-id="${goal.id}" data-goal-date="${date}">
            <input type="checkbox" class="goal-checkbox h-5 w-5 rounded text-indigo-600" ${goal.completed ? 'checked' : ''} ${goal.isRunning ? 'disabled' : ''} />
            <div class="ml-3 flex-grow">
                <span class="${goal.completed ? 'line-through text-indigo-400' : ''}">${goal.text}</span>
                <div class="text-xs text-indigo-500 timer-display ${goal.isRunning ? 'text-green-600' : ''}">${formatTime(getTotalTimeSpent(goal))}</div>
            </div>
            <div class="flex items-center gap-2 ml-3">
                ${!goal.completed ? (goal.isRunning
                    ? `<button class="stop-btn timer-control-btn" data-action="stop">â– </button>`
                    : `<button class="play-btn timer-control-btn" data-action="start">â–¶</button>`
                ) : ''}
                <button class="delete-goal-btn text-indigo-400 hover:text-red-500" title="Delete Goal">X</button>
            </div>
        </div>
    `).join('');

    goals.forEach(g => { if (g.isRunning) startTimerDisplay(memberId, date, g.id); });
}

function renderMessages(messages) {
    const container = document.getElementById('messages-container');
    container.innerHTML = messages.map(msg => {
        const msgData = msg.data();
        const isSent = msgData.senderId === currentMessengerId;
        const linkRegex = /(https?:\/\/\S+)/g;
        const textWithLinks = (msgData.text || '').replace(linkRegex, `<a href="$1" target="_blank" class="link-bubble">$1</a>`);

        return `
        <div class="message flex flex-col ${isSent ? 'sent' : 'received'} fade-in" data-id="${msg.id}">
            <span class="font-bold text-sm text-indigo-700">${msgData.senderName}</span>
            <p class="text-slate-800 break-words">${textWithLinks}</p>
            <span class="text-xs text-slate-500 mt-1 self-end">${msgData.createdAt ? new Date(msgData.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</span>
        </div>`;
    }).join('');
    container.scrollTop = container.scrollHeight;
}

function updateMessengerUserSelect() {
    const select = document.getElementById('messenger-user-select');
    select.innerHTML = '<option value="">-- Select your name --</option>' + allMembersData.map(member =>
        `<option value="${member.id}" ${member.id === currentMessengerId ? 'selected' : ''}>${member.name}</option>`
    ).join('');
}

// --- Data Seeding ---
async function seedInitialMonthlyTasks() {
    const monthStr = getYearMonthString(new Date());
    const seedFlag = `tasksSeeded_${monthStr}`;
    if (localStorage.getItem(seedFlag) || allMembersData.length === 0) {
        return;
    }
    console.log("Seeding initial monthly tasks for", monthStr);
    const tasksToAdd = [
        "Anatomy: Thyroid Gland", "Anatomy: Brachial Plexus", "Anatomy: Muscles of Mastication", "Anatomy: Shoulder Joint", "Anatomy: Blood Supply of Heart", "Anatomy: Mammary Gland", "Anatomy: Right Atrium",
        "Anatomy: Circle of Willis", "Anatomy: Cavernous Sinus", "Anatomy: Cubital Fossa", "Anatomy: Thoracic Duct", "Anatomy: Clavipectoral Fascia", "Anatomy: Development of Tongue", "Anatomy: Corpus Callosum", "Anatomy: Falx Cerebri", "Anatomy: Microscopic structure of Palatine Tonsil", "Anatomy: Notochord", "Anatomy: Axillary Artery", "Anatomy: Bronchopulmonary Segments", "Anatomy: Deltoid Muscle", "Anatomy: Azygos Vein", "Anatomy: Pectoralis Major", "Anatomy: Ciliary Ganglion", "Anatomy: Inferior Cerebellar Peduncle",
        "Anatomy: Sternal Angle", "Anatomy: Nerve Supply of Tongue / Innervation of Tongue", "Anatomy: Median Nerve in Carpal Tunnel", "Anatomy: Cephalic Vein", "Anatomy: Palmar Aponeurosis", "Anatomy: External Jugular Vein", "Anatomy: Dermatome", "Anatomy: First Rib", "Anatomy: Coracoid Process", "Anatomy: Filum Terminale",
        "Anatomy: Ischiorectal Fossa", "Anatomy: Urinary Bladder", "Anatomy: Knee Joint", "Anatomy: Hip Joint", "Anatomy: Pancreas", "Anatomy: Femoral Triangle", "Anatomy: Uterus", "Anatomy: Sciatic Nerve",
        "Anatomy: Femoral Sheath", "Anatomy: Epiploic Foramen", "Anatomy: Microscopic structure of Duodenum", "Anatomy: Development of Spleen", "Anatomy: Microscopic structure of Pancreas", "Anatomy: Supports of Uterus", "Anatomy: Dorsalis Pedis Artery", "Anatomy: Development of Pancreas", "Anatomy: Portal Vein", "Anatomy: Adductor Canal", "Anatomy: Portocaval Anastomosis", "Anatomy: Caecum", "Anatomy: Microscopic Structure of Ovary", "Anatomy: Prostate", "Anatomy: Pelvic Diaphragm", "Anatomy: Blood Supply of Stomach",
        "Anatomy: Barr Body", "Anatomy: Positions of Appendix", "Anatomy: Derivatives of Midgut", "Anatomy: Derivatives of Mesonephric Duct", "Anatomy: Development of Uterus", "Anatomy: Nerve Supply of Urinary Bladder", "Anatomy: Ligaments of Spleen",
        "Physiology: Formation of Urine / Concentrated Urine", "Physiology: Regulation of Cardiac Output", "Physiology: Coagulation Cascade / Mechanism of Blood Coagulation", "Physiology: Plasma Proteins", "Physiology: Hypoxia", "Physiology: ECG", "Physiology: Regulation of Blood Pressure", "Physiology: Cardiac Cycle",
        "Physiology: Rennin-Angiotensin Mechanism", "Physiology: Complications of Mismatched Blood Transfusion", "Physiology: Deglutition Reflex / Second Stage of Deglutition", "Physiology: Oxygen-Dissociation Curve", "Physiology: Functions of Stomach", "Physiology: Active Transport", "Physiology: Chloride Shift", "Physiology: Glomerular Filtration Rate (GFR)", "Physiology: P-R Interval", "Physiology: Baroreceptors / Sino-Aortic Reflex", "Physiology: Functions of Plasma Proteins", "Physiology: Surfactant / Pulmonary Surfactant",
        "Physiology: Triple Response", "Physiology: Periodic Breathing / Cheyne-Stokes Respiration", "Physiology: Vagal Tone", "Physiology: Alkaline Tide", "Physiology: Juxtaglomerular Apparatus", "Physiology: Facilitated Diffusion", "Physiology: Cyanosis", "Physiology: Heart Sounds",
        "Physiology: Thyroid Hormones", "Physiology: Regulation of Menstrual Cycle", "Physiology: Muscle Spindle and Muscle Tone", "Physiology: Basal Ganglia", "Physiology: Neuromuscular Junction", "Physiology: Pain Pathway", "Physiology: Growth Hormone", "Physiology: Calcium Homeostasis / Hormones Regulating Calcium Level",
        "Physiology: UMN and LMN Lesion", "Physiology: Refractive Errors of the Eye", "Physiology: Functions of Middle Ear", "Physiology: Referred Pain", "Physiology: Stretch Reflex", "Physiology: Spermatogenesis", "Physiology: Visual Pathway", "Physiology: Cushing's Syndrome", "Physiology: Endometrial changes during Menstrual Cycle", "Physiology: Actions of Insulin", "Physiology: Functions of Hypothalamus", "Physiology: Functions of Cerebellum",
        "Physiology: Cretinism / Myxoedema", "Physiology: Saltatory Conduction", "Physiology: Inhibin", "Physiology: Oxytocin", "Physiology: Taste Buds / Taste Pathway", "Physiology: Acromegaly", "Physiology: Functions of ADH", "Physiology: Aphasia", "Physiology: Babinski's Sign", "Physiology: Renshaw Cell Inhibition",
        "Biochemistry: TCA Cycle / Citric Acid Cycle", "Biochemistry: Metabolism of Phenylalanine and Tyrosine",
        "Biochemistry: Fatty Liver and Lipotropic Factors", "Biochemistry: Urea Formation / Urea Cycle", "Biochemistry: Glycogenolysis", "Biochemistry: Competitive Inhibition", "Biochemistry: Antioxidants", "Biochemistry: Metabolic changes in Diabetes Mellitus", "Biochemistry: Glycogenesis", "Biochemistry: Cell Membrane", "Biochemistry: Compounds derived from Cholesterol",
        "Biochemistry: Oncogenes", "Biochemistry: Uncouplers of Oxidative Phosphorylation", "Biochemistry: Significance of HMP Pathway", "Biochemistry: Tumor markers", "Biochemistry: Essential Amino Acids", "Biochemistry: Endoplasmic Reticulum",
        "Biochemistry: Regulation of blood Calcium level", "Biochemistry: Biosynthesis of Protein / Translation", "Biochemistry: Recombinant DNA technology", "Biochemistry: Catabolism of Purine Nucleotides",
        "Biochemistry: Renal mechanisms in Acid Base Balance", "Biochemistry: Genetic Code", "Biochemistry: Catabolism of Purines", "Biochemistry: Formation of Bilirubin", "Biochemistry: Metabolic Acidosis", "Biochemistry: BMR (Basal Metabolic Rate)", "Biochemistry: Polymerase Chain Reaction (PCR)", "Biochemistry: Porphyrias",
        "Biochemistry: Creatinine Clearance Test", "Biochemistry: Dietary Fiber", "Biochemistry: Gout"
    ];
    const completedBy = Object.fromEntries(allMembersData.map(m => [m.id, false]));
    const newTasks = tasksToAdd.map(text => ({ id: crypto.randomUUID(), text, completedBy }));
    const batch = writeBatch(db);
    allMembersData.forEach(member => {
        const ref = doc(db, "members", member.id);
        batch.update(ref, { [`monthlyTasks.${monthStr}`]: arrayUnion(...newTasks) });
    });
    try {
        await batch.commit();
        localStorage.setItem(seedFlag, 'true');
        console.log("Successfully seeded tasks.");
    } catch (error) { console.error("Failed to seed tasks:", error); }
}

// --- Event Handlers & Logic ---
async function handleMemberEvents(e) {
  const memberCard = e.target.closest('[data-id]');
  if (!memberCard) return;
  const memberId = memberCard.dataset.id;
  const memberDocRef = doc(db, 'members', memberId);

  // Date picker change
  if (e.target.matches('.member-date-picker')) {
    memberViewStates[memberId].date = e.target.value;
    updateMemberCard(memberCard, allMembersData.find(m => m.id === memberId));
    return;
  }
  
  // Delete Member
  if (e.target.closest('.delete-member-btn')) {
    if (confirm('Are you sure you want to delete this member?')) await deleteDoc(memberDocRef);
    return;
  }

  // Add Daily Goal
  if (e.target.matches('.add-goal-btn')) {
    const input = memberCard.querySelector('.new-goal-input');
    const text = input.value.trim();
    const date = memberViewStates[memberId].date;
    if (text && date) {
      const newGoal = { id: crypto.randomUUID(), text, completed: false, totalTime: 0, isRunning: false, startTime: null };
      await updateDoc(memberDocRef, { [`dailyTasks.${date}`]: arrayUnion(newGoal) });
      input.value = '';
    }
    return;
  }
  
  // Carry forward daily tasks
  if (e.target.matches('.carry-forward-btn')) {
      const dateStr = memberViewStates[memberId].date;
      const member = allMembersData.find(m => m.id === memberId);
      const incompleteTasks = (member.dailyTasks?.[dateStr] || []).filter(t => !t.completed);
      if (incompleteTasks.length === 0) {
          alert('No incomplete tasks to carry over!'); return;
      }
      const nextDay = new Date(dateStr);
      nextDay.setDate(nextDay.getDate() + 2); // Correct for timezone offset in date creation
      const nextDateStr = getLocalDateString(nextDay);
      const tasksToCarry = incompleteTasks.map(t => ({...t, id: crypto.randomUUID(), completed: false, totalTime: 0, isRunning: false, startTime: null}));
      
      await updateDoc(memberDocRef, { [`dailyTasks.${nextDateStr}`]: arrayUnion(...tasksToCarry) });
      alert(`Carried over ${tasksToCarry.length} task(s) to ${nextDateStr}.`);
      return;
  }
  
  // --- Daily Goal-specific actions ---
  const goalItem = e.target.closest('.goal-item');
  if (!goalItem) return;
  const { goalId, goalDate } = goalItem.dataset;
  if (!goalId || !goalDate) return;

  // Timer Control
  if (e.target.closest('.timer-control-btn')) {
    const action = e.target.closest('.timer-control-btn').dataset.action;
    await handleTimerAction(memberDocRef, goalDate, goalId, action);
    return;
  }

  // Daily Goal Deletion / Checkbox
  try {
    await runTransaction(db, async (transaction) => {
      const targetDoc = await transaction.get(memberDocRef);
      if (!targetDoc.exists()) throw "Document does not exist!";
      
      const tasks = targetDoc.data().dailyTasks || {};
      if (e.target.closest('.delete-goal-btn')) {
        tasks[goalDate] = (tasks[goalDate] || []).filter(g => g.id !== goalId);
        stopTimerDisplay(memberId, goalId);
      } else if (e.target.matches('.goal-checkbox')) {
        tasks[goalDate] = (tasks[goalDate] || []).map(g => g.id === goalId ? { ...g, completed: e.target.checked } : g);
      }
      transaction.update(memberDocRef, { dailyTasks: tasks });
    });
  } catch (error) { console.error("Goal update failed: ", error); }
}

async function handleSharedMonthlyEvents(e) {
  const monthStr = getYearMonthString(calendarDate);

  // Add Monthly Goal
  if (e.target.matches('#add-monthly-goal-btn')) {
    const input = document.getElementById('new-monthly-goal-input');
    const text = input.value.trim();
    if (!text || allMembersData.length === 0) return;
    
    const completedBy = Object.fromEntries(allMembersData.map(m => [m.id, false]));
    const newMonthlyTask = { id: crypto.randomUUID(), text, completedBy };

    const batch = writeBatch(db);
    allMembersData.forEach(member => {
        const ref = doc(db, "members", member.id);
        batch.update(ref, { [`monthlyTasks.${monthStr}`]: arrayUnion(newMonthlyTask) });
    });
    await batch.commit();
    input.value = '';
    return;
  }

  const goalItem = e.target.closest('.goal-item');
  if (!goalItem) return;
  const taskId = goalItem.dataset.taskId;

  // Monthly Goal Checkbox Change
  if (e.target.matches('.monthly-goal-checkbox')) {
      const targetMemberId = e.target.dataset.memberId;
      const isChecked = e.target.checked;
      
      const firstMember = allMembersData[0];
      if (!firstMember) return;
      const currentMonthTasks = firstMember.monthlyTasks?.[monthStr] || [];

      const updatedMonthTasks = currentMonthTasks.map(task => {
          if (task.id === taskId) {
              const updatedCompletedBy = { ...task.completedBy, [targetMemberId]: isChecked };
              return { ...task, completedBy: updatedCompletedBy };
          }
          return task;
      });

      const batch = writeBatch(db);
      allMembersData.forEach(member => {
          const ref = doc(db, "members", member.id);
          batch.update(ref, { [`monthlyTasks.${monthStr}`]: updatedMonthTasks });
      });
      await batch.commit();
      return;
  }

  // Copy Monthly task to Daily
  if (e.target.closest('.copy-to-daily-btn')) {
      if (!currentMessengerId) {
          alert("Please select your name from the 'I am:' dropdown in the messenger first.");
          return;
      }
      const member = allMembersData.find(m => m.id === currentMessengerId);
      const memberDocRef = doc(db, 'members', currentMessengerId);
      const taskText = allMembersData[0]?.monthlyTasks?.[monthStr]?.find(t => t.id === taskId)?.text;

      if (taskText && member) {
          const date = memberViewStates[member.id]?.date || TODAY_STRING;
          const newGoal = { id: crypto.randomUUID(), text: taskText, completed: false, totalTime: 0, isRunning: false, startTime: null };
          await updateDoc(memberDocRef, { [`dailyTasks.${date}`]: arrayUnion(newGoal) });
          alert(`'${taskText}' added to your daily goals for ${date}!`);
      }
      return;
  }

  // Delete Monthly Goal
  if (e.target.closest('.delete-goal-btn')) {
      if (!confirm("Are you sure you want to delete this group goal for everyone?")) return;
      
      const firstMember = allMembersData[0];
      if (!firstMember) return;
      const currentMonthTasks = firstMember.monthlyTasks?.[monthStr] || [];
      const updatedMonthTasks = currentMonthTasks.filter(t => t.id !== taskId);

      const batch = writeBatch(db);
      allMembersData.forEach(member => {
          const ref = doc(db, "members", member.id);
          batch.update(ref, { [`monthlyTasks.${monthStr}`]: updatedMonthTasks });
      });
      await batch.commit();
      return;
  }
}

async function handleTimerAction(memberDocRef, date, goalId, action) {
  await runTransaction(db, async (transaction) => {
    const memberDoc = await transaction.get(memberDocRef);
    if (!memberDoc.exists()) return;
    const tasks = memberDoc.data().dailyTasks || {};
    let goals = tasks[date] || [];
    const now = Date.now();
    goals = goals.map(g => ({ ...g, isRunning: false, totalTime: g.isRunning ? getTotalTimeSpent(g) : g.totalTime }));
    if (action === 'start') {
        goals = goals.map(g => g.id === goalId ? { ...g, isRunning: true, startTime: now } : g);
    }
    tasks[date] = goals;
    transaction.update(memberDocRef, { dailyTasks: tasks });
  });
}

// --- Timer Display Management ---
function startTimerDisplay(memberId, date, goalId) {
    const intervalKey = `${memberId}-${goalId}`;
    if (timerIntervals[intervalKey]) return;
    timerIntervals[intervalKey] = setInterval(() => {
        const member = allMembersData.find(m => m.id === memberId);
        if (!member) { stopTimerDisplay(memberId, goalId); return; }
        const goal = member.dailyTasks?.[date]?.find(g => g.id === goalId);
        if (!goal || !goal.isRunning) { stopTimerDisplay(memberId, goalId); return; }
        const goalEl = document.querySelector(`[data-id="${memberId}"] [data-goal-id="${goalId}"]`);
        if (goalEl) {
            goalEl.querySelector('.timer-display').textContent = formatTime(getTotalTimeSpent(goal));
        }
    }, 1000);
}

function stopTimerDisplay(memberId, goalId) {
    const intervalKey = `${memberId}-${goalId}`;
    if (timerIntervals[intervalKey]) {
        clearInterval(timerIntervals[intervalKey]);
        delete timerIntervals[intervalKey];
    }
}

// --- Initializer ---
function setupEventHandlers() {
  document.getElementById('add-member-btn').addEventListener('click', async () => {
    const input = document.getElementById('new-member-name-input');
    const name = input.value.trim();
    if (!name) return;
    await addDoc(collection(db, 'members'), {
      name, dailyTasks: {}, monthlyTasks: {}, createdAt: serverTimestamp(), avatarColor: pickColorForName(name)
    });
    input.value = '';
  });

  document.getElementById('master-calendar-container').addEventListener('click', (e) => {
    if (e.target.closest('#prev-month-btn')) calendarDate.setMonth(calendarDate.getMonth() - 1);
    if (e.target.closest('#next-month-btn')) calendarDate.setMonth(calendarDate.getMonth() + 1);
    
    const dayCell = e.target.closest('.calendar-day');
    if (dayCell) {
      allMembersData.forEach(member => {
          if (!memberViewStates[member.id]) memberViewStates[member.id] = {};
          memberViewStates[member.id].date = dayCell.dataset.date;
      });
      updateMembersUI(allMembersData);
    } else {
        renderApp();
    }
  });

  const membersContainer = document.getElementById('members-container');
  membersContainer.addEventListener('click', handleMemberEvents);
  membersContainer.addEventListener('change', handleMemberEvents);

  const monthlyContainer = document.getElementById('monthly-goals-container');
  monthlyContainer.addEventListener('click', handleSharedMonthlyEvents);
  monthlyContainer.addEventListener('change', handleSharedMonthlyEvents);

  document.getElementById('messenger-user-select').addEventListener('change', (e) => {
      currentMessengerId = e.target.value;
      localStorage.setItem('currentMessengerId', currentMessengerId);
      renderSharedMonthlyView(); // Re-render to show personal progress
      identifyUserInOneSignal(currentMessengerId);
  });

  const sendMessage = async () => {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!currentMessengerId || !text) return;
    const sender = allMembersData.find(m => m.id === currentMessengerId);
    if (!sender) return;
    await addDoc(collection(db, 'messages'), {
        text, senderId: currentMessengerId, senderName: sender.name, createdAt: serverTimestamp()
    });
    input.value = '';
  };

  document.getElementById('send-message-btn').addEventListener('click', sendMessage);
  document.getElementById('message-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
}

function setupFirestoreListeners() {
  onSnapshot(query(collection(db, 'members'), orderBy('name', 'asc')), (snapshot) => {
    allMembersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    seedInitialMonthlyTasks();
    renderApp();
    if (currentMessengerId) {
        identifyUserInOneSignal(currentMessengerId);
    }
  });
  
  onSnapshot(query(collection(db, 'messages'), orderBy('createdAt', 'asc')), (snapshot) => renderMessages(snapshot.docs));
}

function main() {
  setupEventHandlers();
  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById('loader').textContent = "Loading members..."; 
      setupFirestoreListeners();
    } else {
      signInAnonymously(auth).catch((error) => {
        console.error("Anonymous sign-in failed:", error);
        document.getElementById('loader').textContent = "Connection failed. Please refresh.";
      });
    }
  });
}

main();
</script>

</body>
</html>
